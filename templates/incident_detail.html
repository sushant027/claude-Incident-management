<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Detail - Incident Management</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* --- Timeline Flow CSS --- */
        .timeline {
            position: relative;
            padding: 20px 0;
            margin-top: 20px;
        }

        /* The vertical line */
        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 20px;
            width: 2px;
            background: #e0e0e0;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-left: 50px;
        }

        /* The dots on the line */
        .timeline-marker {
            position: absolute;
            left: 13px;
            top: 5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff; /* Primary color */
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px #007bff;
            z-index: 1;
        }

        /* Styling for different status types */
        .marker-status-change { background: #ffc107; box-shadow: 0 0 0 2px #ffc107; }
        .marker-comment { background: #6c757d; box-shadow: 0 0 0 2px #6c757d; }
        .marker-resolved { background: #28a745; box-shadow: 0 0 0 2px #28a745; }

        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .timeline-title {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #333;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .timeline-desc {
            margin: 0 0 10px 0;
            color: #555;
            line-height: 1.4;
        }

        .timeline-meta {
            font-size: 0.8rem;
            color: #888;
            display: flex;
            justify-content: space-between;
        }

        /* Utility classes from your existing style might be needed */
        .hidden { display: none; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="navbar-brand">Incident Management</a>
        <ul class="navbar-menu">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/incidents-list">Incidents</a></li>
            <li><a href="/search">Search</a></li>
            <li><a href="/bank-options">Bank Options</a></li>
        </ul>
        <div class="navbar-user">
            <span>{{ user.name }} ({{ user.role }})</span>
            <button onclick="logout()" class="btn btn-small btn-secondary">Logout</button>
        </div>
    </nav>

    <div class="container-wide">
        <div class="flex-between mb-2">
            <h1 id="incident-title">Incident #{{ incident_id }}</h1>
            <a href="/incidents-list" class="btn btn-secondary">Back to List</a>
        </div>

        <div class="card">
            <div class="card-header">Incident Details</div>
            <div id="incident-details"></div>
        </div>

        <div class="card">
            <div class="card-header">Actions</div>
            <div class="flex gap-1" id="actions-container" style="display: flex; gap: 10px; padding: 15px;"></div>
        </div>

        <div class="card">
            <div class="card-header">Activity Timeline</div>
            <div class="timeline" id="timeline"></div>
        </div>

        <div id="ai-similar" class="card hidden">
            <div class="card-header">Similar Incidents (AI)</div>
            <div id="ai-content"></div>
        </div>
    </div>

    <script>
        const incidentId = {{ incident_id }};
        let incident = null;

        async function loadIncident() {
            try {
                const response = await fetch(`/incidents/${incidentId}`);
                incident = await response.json();

                document.getElementById('incident-title').textContent = `Incident #${incident.id}: ${incident.title}`;

                document.getElementById('incident-details').innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr><td style="padding: 10px; width: 200px; font-weight: bold; border-bottom: 1px solid #eee;">Title:</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${incident.title}</td></tr>
                        <tr><td style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Description:</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${incident.description}</td></tr>
                        <tr><td style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Service:</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${incident.service_name}</td></tr>
                        <tr><td style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Severity:</td><td style="padding: 10px; border-bottom: 1px solid #eee;"><span class="badge badge-${incident.severity.toLowerCase()}">${incident.severity}</span></td></tr>
                        <tr><td style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Status:</td><td style="padding: 10px; border-bottom: 1px solid #eee;"><span class="badge badge-${incident.status.toLowerCase().replace('_', '-')}">${incident.status.replace('_', ' ')}</span></td></tr>
                        <tr><td style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Bank:</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${incident.bank_name}</td></tr>
                        <tr><td style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Created By:</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${incident.created_by_name}</td></tr>
                        <tr><td style="padding: 10px; font-weight: bold; border-bottom: 1px solid #eee;">Created At:</td><td style="padding: 10px; border-bottom: 1px solid #eee;">${new Date(incident.created_at).toLocaleString()}</td></tr>
                        ${incident.exception_text ? `<tr><td style="padding: 10px; font-weight: bold;">Exception:</td><td><pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto;">${incident.exception_text}</pre></td></tr>` : ''}
                    </table>
                `;

                renderActions();
                renderTimeline(incident.timeline);
                renderAISimilar(incident.ai_similar);
            } catch (err) {
                console.error("Failed to load incident", err);
            }
        }

        function renderActions() {
            const actions = [];
            const userRole = '{{ user.role }}';

            if (incident.status === 'OPEN') {
                if (['SUPPORT_L2', 'SUPPORT_EXPERT', 'INCIDENT_MANAGER', 'ADMIN'].includes(userRole)) {
                    actions.push('<button onclick="updateStatus(\'ACKNOWLEDGED\')" class="btn btn-primary">Acknowledge</button>');
                }
            } else if (incident.status === 'ACKNOWLEDGED') {
                actions.push('<button onclick="updateStatus(\'IN_PROGRESS\')" class="btn btn-primary">Move to In Progress</button>');
            } else if (incident.status === 'IN_PROGRESS') {
                if (['INCIDENT_MANAGER', 'ADMIN'].includes(userRole)) {
                    actions.push('<button onclick="updateStatus(\'RESOLVED\')" class="btn btn-success">Resolve</button>');
                }
            } else if (incident.status === 'RESOLVED') {
                if (['INCIDENT_MANAGER', 'ADMIN'].includes(userRole)) {
                    actions.push('<button onclick="updateStatus(\'CLOSED\')" class="btn btn-success">Close</button>');
                }
            }

            actions.push('<button onclick="addComment()" class="btn btn-secondary">Add Comment</button>');
            actions.push('<button onclick="triggerAISearch()" class="btn btn-secondary">Run AI Search</button>');

            if (['RESOLVED', 'CLOSED'].includes(incident.status)) {
                actions.push(`<a href="/reports/incident/${incidentId}" target="_blank" class="btn btn-secondary">Generate Report</a>`);
            }

            document.getElementById('actions-container').innerHTML = actions.join('');
        }

        function renderTimeline(timeline) {
            const container = document.getElementById('timeline');
            if (!timeline || timeline.length === 0) {
                container.innerHTML = '<p style="padding: 20px;">No timeline events recorded yet.</p>';
                return;
            }

            container.innerHTML = timeline.map(event => {
                // Determine marker color based on event type
                let markerClass = '';
                if (event.event_type.includes('STATUS')) markerClass = 'marker-status-change';
                if (event.event_type.includes('COMMENT')) markerClass = 'marker-comment';
                if (event.event_type.includes('RESOLVED')) markerClass = 'marker-resolved';

                return `
                    <div class="timeline-item">
                        <div class="timeline-marker ${markerClass}"></div>
                        <div class="timeline-content">
                            <span class="timeline-title">${event.event_type.replace(/_/g, ' ')}</span>
                            <p class="timeline-desc">${event.event_description}</p>
                            <div class="timeline-meta">
                                <span><i class="user-icon">ðŸ‘¤</i> ${event.performed_by_name}</span>
                                <span>${new Date(event.created_at).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAISimilar(aiData) {
            if (!aiData || !aiData.similar_incident_ids || aiData.similar_incident_ids.length === 0) {
                return;
            }

            document.getElementById('ai-similar').classList.remove('hidden');
            document.getElementById('ai-content').innerHTML = `
                <div style="padding: 15px;">
                    <p><strong>Recommendation:</strong> ${aiData.recommendation_text}</p>
                    <p><strong>Similar Incidents:</strong></p>
                    <ul style="list-style: none; padding-left: 0;">
                        ${aiData.similar_incident_ids.map(id => `
                            <li style="margin-bottom: 8px; padding: 8px; background: #f0f4f8; border-radius: 4px;">
                                <a href="/incidents-detail/${id}" style="font-weight: bold;">Incident #${id}</a>
                                <br><small style="color: #666;">${aiData.similarity_reasons[id] ? aiData.similarity_reasons[id] : ''}</small>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        async function updateStatus(newStatus) {
            const comment = prompt('Add a comment (optional):');
            const response = await fetch(`/incidents/${incidentId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus, comment })
            });

            if (response.ok) {
                loadIncident();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to update status'));
            }
        }

        async function addComment() {
            const comment = prompt('Enter comment:');
            if (!comment) return;

            const response = await fetch(`/incidents/${incidentId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comment })
            });

            if (response.ok) {
                loadIncident();
            } else {
                alert('Failed to add comment');
            }
        }

        async function triggerAISearch() {
            if (!confirm('Run AI similar incident search?')) return;
            const response = await fetch(`/incidents/${incidentId}/ai-search`, { method: 'POST' });
            if (response.ok) {
                alert('AI search completed');
                loadIncident();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'AI search failed'));
            }
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        loadIncident();
    </script>
</body>
</html>