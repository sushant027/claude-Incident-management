<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Options - Incident Management</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        .bank-selector {
            margin-bottom: 20px;
        }
        .bank-selector select {
            padding: 10px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 250px;
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .section-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-card h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #1f3a5f;
            color: #1f3a5f;
        }
        .option-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .option-row:last-child {
            border-bottom: none;
        }
        .option-label {
            font-weight: 600;
            color: #555;
        }
        .option-value {
            color: #333;
            text-align: right;
            max-width: 60%;
        }
        .badge-yes {
            background-color: #38a169;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        .badge-no {
            background-color: #e53e3e;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        .badge-tech {
            background-color: #3182ce;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .btn-edit {
            background: #3182ce;
        }
        .btn-edit:hover {
            background: #2c5282;
        }
        .btn-delete {
            background: #e53e3e;
        }
        .btn-delete:hover {
            background: #c53030;
        }
        .architecture-diagram {
            margin-top: 10px;
        }
        .architecture-diagram img {
            max-width: 100%;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .architecture-diagram a {
            color: #3182ce;
            text-decoration: none;
        }
        .architecture-diagram a:hover {
            text-decoration: underline;
        }
        .volume-number {
            font-size: 18px;
            font-weight: bold;
            color: #1f3a5f;
        }
        .description-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        .updated-info {
            margin-top: 20px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        /* Chart styles */
        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1f3a5f;
            color: #1f3a5f;
        }
        .chart-container {
            position: relative;
            height: 220px;
            width: 100%;
        }
        .volume-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .volume-stat {
            text-align: center;
        }
        .volume-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .volume-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #1f3a5f;
        }
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #1f3a5f;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .modal-close:hover {
            color: #333;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* Architecture diagram display */
        .arch-diagram-container {
            margin-top: 15px;
            text-align: center;
        }
        .arch-diagram-img {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
        }
        .arch-diagram-img:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .section-card-full {
            grid-column: 1 / -1;
        }
        /* Image preview modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: pointer;
        }
        .image-preview-modal img {
            max-width: 95%;
            max-height: 95%;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="navbar-brand">Incident Management</a>
        <ul class="navbar-menu">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/incidents-list">Incidents</a></li>
            <li><a href="/search">Search</a></li>
            <li><a href="/bank-options" class="active">Bank Options</a></li>
        </ul>
        <div class="navbar-user">
            <span>{{ user.name }} ({{ user.role }})</span>
            <button onclick="logout()" class="btn btn-small btn-secondary">Logout</button>
        </div>
    </nav>

    <div class="container">
        <h1>Bank Options</h1>

        <div class="bank-selector">
            <label for="bank-select"><strong>Select Bank:</strong></label>
            <select id="bank-select" onchange="loadBankOptions()">
                <option value="">-- Select a Bank --</option>
            </select>
            {% if user.role == 'ADMIN' %}
            <button onclick="showAddBankModal()" class="btn btn-primary" id="btn-add-bank">+ Add New Bank</button>
            <button onclick="editBankOption()" class="btn btn-edit" id="btn-edit" style="display:none;">Edit Configuration</button>
            <button onclick="deleteBankOption()" class="btn btn-delete" id="btn-delete" style="display:none;">Delete</button>
            <button onclick="createBankOption()" class="btn btn-success" id="btn-create" style="display:none;">Create Configuration</button>
            <button onclick="showUploadDiagramModal()" class="btn btn-secondary" id="btn-upload" style="display:none;">Upload Diagram</button>
            {% endif %}
        </div>

        <div id="options-content">
            <div class="no-data">
                <h3>Select a bank to view its configuration</h3>
            </div>
        </div>
    </div>

    <!-- Add Bank Modal -->
    <div id="add-bank-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Bank</h2>
                <button onclick="closeAddBankModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Bank Name *</label>
                    <input type="text" id="new-bank-name" class="form-input" placeholder="Enter bank name" required>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddBankModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="createNewBank()" class="btn btn-success">Create Bank</button>
            </div>
        </div>
    </div>

    <!-- Upload Diagram Modal -->
    <div id="upload-diagram-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload Architecture Diagram</h2>
                <button onclick="closeUploadModal()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Image File</label>
                    <input type="file" id="diagram-file" class="form-input" accept=".png,.jpg,.jpeg,.gif,.webp,.svg,.pdf">
                    <small class="text-muted">Allowed: PNG, JPG, JPEG, GIF, WEBP, SVG, PDF</small>
                </div>
                <div id="upload-preview" style="margin-top: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeUploadModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="uploadDiagram()" class="btn btn-success">Upload</button>
            </div>
        </div>
    </div>

    <script>
        let currentBankId = null;
        let currentBankOption = null;

        async function loadBanks() {
            try {
                const response = await fetch('/banks');
                const banks = await response.json();

                const select = document.getElementById('bank-select');
                banks.forEach(bank => {
                    const option = document.createElement('option');
                    option.value = bank.id;
                    option.textContent = bank.name;
                    select.appendChild(option);
                });

                // Check URL for bank_id parameter
                const urlParams = new URLSearchParams(window.location.search);
                const bankIdParam = urlParams.get('bank_id');
                if (bankIdParam) {
                    select.value = bankIdParam;
                    loadBankOptions();
                }
            } catch (error) {
                console.error('Error loading banks:', error);
            }
        }

        async function loadBankOptions() {
            const select = document.getElementById('bank-select');
            const bankId = select.value;

            if (!bankId) {
                document.getElementById('options-content').innerHTML = `
                    <div class="no-data">
                        <h3>Select a bank to view its configuration</h3>
                    </div>
                `;
                hideButtons();
                return;
            }

            currentBankId = bankId;

            try {
                const response = await fetch(`/api/bank-options/${bankId}`);
                const data = await response.json();

                currentBankOption = data;

                if (!data.exists) {
                    document.getElementById('options-content').innerHTML = `
                        <div class="no-data">
                            <h3>No configuration found for ${data.bank_name}</h3>
                            <p>Click "Create Configuration" to add technical details for this bank.</p>
                        </div>
                    `;
                    showCreateButton();
                    return;
                }

                showEditDeleteButtons();
                renderBankOptions(data);

            } catch (error) {
                console.error('Error loading bank options:', error);
                document.getElementById('options-content').innerHTML = `
                    <div class="no-data">
                        <h3>Error loading bank options</h3>
                    </div>
                `;
            }
        }

        function renderBankOptions(data) {
            const formatNumber = (num) => {
                if (num === null || num === undefined) return 'N/A';
                return num.toLocaleString();
            };

            const formatShortNumber = (num) => {
                if (num === null || num === undefined) return 'N/A';
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            const yesNo = (val) => val ? '<span class="badge-yes">Yes</span>' : '<span class="badge-no">No</span>';

            const content = `
                <!-- Transaction Volume Charts Section -->
                <div class="chart-row">
                    <div class="chart-card">
                        <h3>Transaction Volume</h3>
                        <div class="chart-container">
                            <canvas id="volumeChart"></canvas>
                        </div>
                        <div class="volume-stats">
                            <div class="volume-stat">
                                <span class="volume-label">Daily Volume</span>
                                <span class="volume-value">${formatNumber(data.transaction_volume_per_day)}</span>
                            </div>
                            <div class="volume-stat">
                                <span class="volume-label">Monthly Volume</span>
                                <span class="volume-value">${formatNumber(data.transaction_volume_per_month)}</span>
                            </div>
                            <div class="volume-stat">
                                <span class="volume-label">Peak TPS</span>
                                <span class="volume-value">${data.transaction_volume_per_day ? Math.round(data.transaction_volume_per_day / 86400 * 2).toLocaleString() : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Infrastructure Overview</h3>
                        <div class="chart-container">
                            <canvas id="infraChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="options-grid">

                    <!-- App Server Section -->
                    <div class="section-card">
                        <h3>Application Server</h3>
                        <div class="option-row">
                            <span class="option-label">Number of Servers</span>
                            <span class="option-value">${formatNumber(data.number_of_app_servers)}</span>
                        </div>
                        <div class="option-row">
                            <span class="option-label">Server Type</span>
                            <span class="option-value">${data.app_server_type || 'N/A'}</span>
                        </div>
                    </div>

                    <!-- Database Section -->
                    <div class="section-card">
                        <h3>Database</h3>
                        <div class="option-row">
                            <span class="option-label">Database Type</span>
                            <span class="option-value">${data.db_type || 'N/A'}</span>
                        </div>
                        <div class="option-row">
                            <span class="option-label">Number of Instances</span>
                            <span class="option-value">${formatNumber(data.number_of_db_instances)}</span>
                        </div>
                    </div>

                    <!-- Developer Contacts Section -->
                    <div class="section-card">
                        <h3>Developer Contacts</h3>
                        <div class="option-row">
                            <span class="option-label">Implementation Developer</span>
                            <span class="option-value">${data.implementation_developer_name || 'N/A'}</span>
                        </div>
                        <div class="option-row">
                            <span class="option-label">DB Developer</span>
                            <span class="option-value">${data.db_developer_name || 'N/A'}</span>
                        </div>
                        <div class="option-row">
                            <span class="option-label">DB Developer Contact</span>
                            <span class="option-value">${data.db_developer_contact || 'N/A'}</span>
                        </div>
                    </div>

                    <!-- Aerospike Section -->
                    <div class="section-card">
                        <h3>Aerospike</h3>
                        <div class="option-row">
                            <span class="option-label">Enabled</span>
                            <span class="option-value">${yesNo(data.aerospike_enabled)}</span>
                        </div>
                        ${data.aerospike_enabled ? `
                        <div class="option-row">
                            <span class="option-label">Version</span>
                            <span class="option-value">${data.aerospike_version || 'N/A'}</span>
                        </div>
                        ${data.aerospike_description ? `
                        <div class="description-text">${data.aerospike_description}</div>
                        ` : ''}
                        ` : ''}
                    </div>

                    <!-- Redis Section -->
                    <div class="section-card">
                        <h3>Redis</h3>
                        <div class="option-row">
                            <span class="option-label">Enabled</span>
                            <span class="option-value">${yesNo(data.redis_enabled)}</span>
                        </div>
                        ${data.redis_enabled && data.redis_description ? `
                        <div class="description-text">${data.redis_description}</div>
                        ` : ''}
                    </div>

                    <!-- Recon Section -->
                    <div class="section-card">
                        <h3>Reconciliation (Recon)</h3>
                        <div class="option-row">
                            <span class="option-label">Enabled</span>
                            <span class="option-value">${yesNo(data.recon_enabled)}</span>
                        </div>
                        ${data.recon_enabled ? `
                        <div class="option-row">
                            <span class="option-label">Technology</span>
                            <span class="option-value">
                                ${data.recon_technology ? `<span class="badge-tech">${data.recon_technology}</span>` : 'N/A'}
                            </span>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Architecture Diagram Section -->
                    <div class="section-card section-card-full">
                        <h3>Architecture Diagram</h3>
                        ${data.architecture_diagram_url ? `
                        <div class="arch-diagram-container">
                            ${data.architecture_diagram_url.endsWith('.pdf') ? `
                                <a href="${data.architecture_diagram_url}" target="_blank" class="btn btn-primary">View PDF Diagram</a>
                            ` : `
                                <img src="${data.architecture_diagram_url}" alt="Architecture Diagram" class="arch-diagram-img" onclick="showImagePreview('${data.architecture_diagram_url}')">
                            `}
                            <p style="margin-top: 10px;"><a href="${data.architecture_diagram_url}" target="_blank">Open in new tab</a></p>
                        </div>
                        ` : '<p>No architecture diagram available. Click "Upload Diagram" to add one.</p>'}
                    </div>
                </div>

                <div class="updated-info">
                    Last updated: ${data.updated_at ? new Date(data.updated_at).toLocaleString() : 'N/A'}
                    ${data.updated_by_name ? ` by ${data.updated_by_name}` : ''}
                </div>
            `;

            document.getElementById('options-content').innerHTML = content;

            // Render charts after content is inserted
            renderCharts(data);
        }

        function renderCharts(data) {
            // Destroy existing charts if any
            if (window.volumeChartInstance) {
                window.volumeChartInstance.destroy();
            }
            if (window.infraChartInstance) {
                window.infraChartInstance.destroy();
            }

            // Transaction Volume Bar Chart
            const volumeCtx = document.getElementById('volumeChart');
            if (volumeCtx && (data.transaction_volume_per_day || data.transaction_volume_per_month)) {
                window.volumeChartInstance = new Chart(volumeCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Daily', 'Weekly (Est.)', 'Monthly'],
                        datasets: [{
                            label: 'Transaction Volume',
                            data: [
                                data.transaction_volume_per_day || 0,
                                (data.transaction_volume_per_day || 0) * 7,
                                data.transaction_volume_per_month || 0
                            ],
                            backgroundColor: [
                                'rgba(49, 130, 206, 0.8)',
                                'rgba(56, 161, 105, 0.8)',
                                'rgba(128, 90, 213, 0.8)'
                            ],
                            borderColor: [
                                'rgba(49, 130, 206, 1)',
                                'rgba(56, 161, 105, 1)',
                                'rgba(128, 90, 213, 1)'
                            ],
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y.toLocaleString() + ' transactions';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (volumeCtx) {
                volumeCtx.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">No transaction volume data available</div>';
            }

            // Infrastructure Doughnut Chart
            const infraCtx = document.getElementById('infraChart');
            if (infraCtx) {
                const infraData = [];
                const infraLabels = [];
                const infraColors = [];

                if (data.number_of_app_servers) {
                    infraLabels.push('App Servers');
                    infraData.push(data.number_of_app_servers);
                    infraColors.push('rgba(49, 130, 206, 0.8)');
                }
                if (data.number_of_db_instances) {
                    infraLabels.push('DB Instances');
                    infraData.push(data.number_of_db_instances);
                    infraColors.push('rgba(56, 161, 105, 0.8)');
                }
                if (data.aerospike_enabled) {
                    infraLabels.push('Aerospike');
                    infraData.push(1);
                    infraColors.push('rgba(237, 137, 54, 0.8)');
                }
                if (data.redis_enabled) {
                    infraLabels.push('Redis');
                    infraData.push(1);
                    infraColors.push('rgba(229, 62, 62, 0.8)');
                }
                if (data.recon_enabled) {
                    infraLabels.push('Recon');
                    infraData.push(1);
                    infraColors.push('rgba(128, 90, 213, 0.8)');
                }

                if (infraData.length > 0) {
                    window.infraChartInstance = new Chart(infraCtx, {
                        type: 'doughnut',
                        data: {
                            labels: infraLabels,
                            datasets: [{
                                data: infraData,
                                backgroundColor: infraColors,
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        padding: 15,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                } else {
                    infraCtx.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">No infrastructure data available</div>';
                }
            }
        }

        function hideButtons() {
            document.getElementById('btn-edit')?.style && (document.getElementById('btn-edit').style.display = 'none');
            document.getElementById('btn-delete')?.style && (document.getElementById('btn-delete').style.display = 'none');
            document.getElementById('btn-create')?.style && (document.getElementById('btn-create').style.display = 'none');
            document.getElementById('btn-upload')?.style && (document.getElementById('btn-upload').style.display = 'none');
        }

        function showCreateButton() {
            document.getElementById('btn-edit')?.style && (document.getElementById('btn-edit').style.display = 'none');
            document.getElementById('btn-delete')?.style && (document.getElementById('btn-delete').style.display = 'none');
            document.getElementById('btn-create')?.style && (document.getElementById('btn-create').style.display = 'inline-block');
            document.getElementById('btn-upload')?.style && (document.getElementById('btn-upload').style.display = 'none');
        }

        function showEditDeleteButtons() {
            document.getElementById('btn-edit')?.style && (document.getElementById('btn-edit').style.display = 'inline-block');
            document.getElementById('btn-delete')?.style && (document.getElementById('btn-delete').style.display = 'inline-block');
            document.getElementById('btn-create')?.style && (document.getElementById('btn-create').style.display = 'none');
            document.getElementById('btn-upload')?.style && (document.getElementById('btn-upload').style.display = 'inline-block');
        }

        function editBankOption() {
            if (currentBankId) {
                window.location.href = `/bank-options-edit/${currentBankId}`;
            }
        }

        function createBankOption() {
            if (currentBankId) {
                window.location.href = `/bank-options-edit/${currentBankId}?create=true`;
            }
        }

        async function deleteBankOption() {
            if (!currentBankId) return;

            if (!confirm('Are you sure you want to delete this bank configuration? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/bank-options/${currentBankId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Bank option deleted successfully');
                    loadBankOptions();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to delete bank option'));
                }
            } catch (error) {
                console.error('Error deleting bank option:', error);
                alert('Error deleting bank option');
            }
        }

        // Add Bank Modal Functions
        function showAddBankModal() {
            document.getElementById('add-bank-modal').style.display = 'flex';
            document.getElementById('new-bank-name').value = '';
            document.getElementById('new-bank-name').focus();
        }

        function closeAddBankModal() {
            document.getElementById('add-bank-modal').style.display = 'none';
        }

        async function createNewBank() {
            const bankName = document.getElementById('new-bank-name').value.trim();
            if (!bankName) {
                alert('Please enter a bank name');
                return;
            }

            try {
                const response = await fetch('/banks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: bankName })
                });

                if (response.ok) {
                    const newBank = await response.json();
                    alert(`Bank "${newBank.name}" created successfully!`);
                    closeAddBankModal();

                    // Reload banks and select the new one
                    const select = document.getElementById('bank-select');
                    const option = document.createElement('option');
                    option.value = newBank.id;
                    option.textContent = newBank.name;
                    select.appendChild(option);
                    select.value = newBank.id;
                    loadBankOptions();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to create bank'));
                }
            } catch (error) {
                console.error('Error creating bank:', error);
                alert('Error creating bank');
            }
        }

        // Upload Diagram Modal Functions
        function showUploadDiagramModal() {
            if (!currentBankId) {
                alert('Please select a bank first');
                return;
            }
            document.getElementById('upload-diagram-modal').style.display = 'flex';
            document.getElementById('diagram-file').value = '';
            document.getElementById('upload-preview').innerHTML = '';
        }

        function closeUploadModal() {
            document.getElementById('upload-diagram-modal').style.display = 'none';
        }

        // Preview selected file
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('diagram-file');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('upload-preview').innerHTML = `
                                <img src="${e.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 4px;">
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        async function uploadDiagram() {
            const fileInput = document.getElementById('diagram-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`/api/bank-options/${currentBankId}/upload-diagram`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Diagram uploaded successfully!');
                    closeUploadModal();
                    loadBankOptions(); // Reload to show the new diagram
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to upload diagram'));
                }
            } catch (error) {
                console.error('Error uploading diagram:', error);
                alert('Error uploading diagram');
            }
        }

        // Image Preview Function
        function showImagePreview(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            modal.innerHTML = `<img src="${imageUrl}" alt="Architecture Diagram">`;
            modal.onclick = function() {
                document.body.removeChild(modal);
            };
            document.body.appendChild(modal);
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        loadBanks();
    </script>
</body>
</html>
