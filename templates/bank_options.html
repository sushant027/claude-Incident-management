<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Infrastructure - Incident Management</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Kubernetes Display Styles */
        .k8s-section-card {
            grid-column: 1 / -1;
            background: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .k8s-section-card h3 {
            background: linear-gradient(135deg, #326ce5 0%, #54a3ff 100%);
            color: white;
            padding: var(--spacing-4) var(--spacing-5);
            margin: 0;
            font-size: var(--font-size-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .k8s-section-card h3 .deployment-count {
            background: rgba(255,255,255,0.2);
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
        }
        .k8s-deployments-container {
            max-height: 600px;
            overflow-y: auto;
            padding: var(--spacing-4);
        }
        .k8s-deployments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--spacing-3);
        }
        .k8s-deployment-view-card {
            background: #f8fafc;
            border: 1px solid #326ce5;
            border-radius: var(--border-radius);
            overflow: hidden;
            font-size: var(--font-size-sm);
        }
        .k8s-deployment-view-header {
            background: linear-gradient(135deg, #326ce5 0%, #54a3ff 100%);
            color: white;
            padding: var(--spacing-2) var(--spacing-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .k8s-deployment-view-header h4 {
            margin: 0;
            font-size: var(--font-size-sm);
            font-weight: 600;
        }
        .k8s-deployment-view-header .namespace-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px var(--spacing-2);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
        }
        .k8s-deployment-view-body {
            padding: var(--spacing-3);
        }
        .k8s-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-3);
        }
        .k8s-info-item {
            text-align: center;
            padding: var(--spacing-1);
            background: white;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
        }
        .k8s-info-item .value {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: #326ce5;
        }
        .k8s-info-item .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .k8s-subsection {
            margin-top: var(--spacing-2);
            padding-top: var(--spacing-2);
            border-top: 1px solid var(--border-color);
        }
        .k8s-subsection-title {
            font-weight: 600;
            color: #326ce5;
            margin-bottom: var(--spacing-2);
            font-size: var(--font-size-xs);
            text-transform: uppercase;
        }
        .db-pool-display-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
        }
        .db-pool-display-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 4px;
            text-align: center;
        }
        .db-pool-display-item .schema-name {
            font-weight: 600;
            font-size: 9px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }
        .db-pool-display-item .pool-values {
            font-size: var(--font-size-xs);
            color: #326ce5;
            font-weight: 500;
        }
        .db-pool-display-item .pool-total {
            font-size: 9px;
            color: var(--text-muted);
        }
        .alb-info {
            display: flex;
            gap: var(--spacing-2);
            flex-wrap: wrap;
        }
        .alb-info-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 4px var(--spacing-2);
            font-size: var(--font-size-xs);
        }
        .alb-info-item .label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .alb-info-item .value {
            font-weight: 500;
            color: var(--text-primary);
        }
        /* Total Connection Pool Summary */
        .k8s-total-summary {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            padding: var(--spacing-4);
            margin: var(--spacing-4);
            margin-top: 0;
            border-radius: var(--border-radius);
        }
        .k8s-total-summary-title {
            color: white;
            font-weight: 600;
            margin-bottom: var(--spacing-3);
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .k8s-total-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-3);
        }
        .k8s-total-item {
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-3);
            text-align: center;
        }
        .k8s-total-item .schema-name {
            color: rgba(255,255,255,0.8);
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            margin-bottom: var(--spacing-1);
        }
        .k8s-total-item .total-values {
            color: white;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }
        .k8s-total-item .total-label {
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-xs);
            margin-top: var(--spacing-1);
        }
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-6);
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            margin-bottom: var(--spacing-4);
        }
        .modal-header h2 {
            margin: 0;
            font-size: var(--font-size-xl);
            color: var(--text-primary);
        }
        .modal-body {
            margin-bottom: var(--spacing-4);
        }
        .modal-footer {
            display: flex;
            gap: var(--spacing-3);
            justify-content: flex-end;
        }
        @media (max-width: 768px) {
            .k8s-deployments-grid {
                grid-template-columns: 1fr;
            }
            .k8s-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .db-pool-display-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .k8s-total-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="navbar-brand">Incident Management</a>
        <ul class="navbar-menu">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/incidents-list">Incidents</a></li>
            <li><a href="/search">Search</a></li>
            <li><a href="/bank-options" class="active">Bank Infrastructure</a></li>
        </ul>
        <div class="navbar-user">
            <span>{{ user.name }} ({{ user.role }})</span>
            <button onclick="logout()" class="btn btn-small btn-secondary">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Bank Infrastructure Details</h1>
        </div>

        <div class="bank-selector">
            <label for="bank-select">Select Bank:</label>
            <select id="bank-select" onchange="loadBankOptions()" class="form-select" style="width: auto; min-width: 280px;">
                <option value="">-- Select a Bank --</option>
            </select>
            <button onclick="openAddBankModal()" class="btn btn-primary" id="btn-add-bank" style="margin-left: var(--spacing-3); display:none;">+ Add New Bank</button>
            <div class="action-buttons" style="margin-top: 0;">
                <button onclick="editBankOption()" class="btn btn-edit" id="btn-edit" style="display:none;">Edit Configuration</button>
                <button onclick="deleteBankOption()" class="btn btn-danger" id="btn-delete" style="display:none;">Delete</button>
                <button onclick="createBankOption()" class="btn btn-success" id="btn-create" style="display:none;">Create Configuration</button>
            </div>
        </div>

        <div id="options-content">
            <div class="no-data">
                <h3>Select a bank to view its infrastructure details</h3>
                <p>Choose a bank from the dropdown above to view its technical configuration, server specifications, and infrastructure information.</p>
            </div>
        </div>
    </div>

    <!-- Add New Bank Modal -->
    <div id="add-bank-modal" class="modal-overlay" onclick="closeAddBankModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Add New Bank</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="new-bank-name">Bank Name *</label>
                    <input type="text" id="new-bank-name" class="form-input" placeholder="Enter bank name" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddBankModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewBank()">Add Bank</button>
            </div>
        </div>
    </div>

    <script>
        let currentBankId = null;
        let currentBankOption = null;
        const userRole = '{{ user.role }}';
        const isAdmin = userRole === 'ADMIN' || userRole === 'UserRole.ADMIN';

        // Show Add Bank button for admin users
        if (isAdmin) {
            document.getElementById('btn-add-bank').style.display = 'inline-flex';
        }

        async function loadBanks() {
            try {
                const response = await fetch('/banks');
                const banks = await response.json();

                const select = document.getElementById('bank-select');
                banks.forEach(bank => {
                    const option = document.createElement('option');
                    option.value = bank.id;
                    option.textContent = bank.name;
                    select.appendChild(option);
                });

                const urlParams = new URLSearchParams(window.location.search);
                const bankIdParam = urlParams.get('bank_id');
                if (bankIdParam) {
                    select.value = bankIdParam;
                    loadBankOptions();
                }
            } catch (error) {
                console.error('Error loading banks:', error);
            }
        }

        async function loadBankOptions() {
            const select = document.getElementById('bank-select');
            const bankId = select.value;

            if (!bankId) {
                document.getElementById('options-content').innerHTML = `
                    <div class="no-data">
                        <h3>Select a bank to view its infrastructure details</h3>
                        <p>Choose a bank from the dropdown above to view its technical configuration, server specifications, and infrastructure information.</p>
                    </div>
                `;
                hideButtons();
                return;
            }

            currentBankId = bankId;

            try {
                const response = await fetch(`/api/bank-options/${bankId}`);
                const data = await response.json();

                currentBankOption = data;

                if (!data.exists) {
                    document.getElementById('options-content').innerHTML = `
                        <div class="no-data">
                            <h3>No configuration found for ${data.bank_name}</h3>
                            <p>Click "Create Configuration" to add technical infrastructure details for this bank.</p>
                        </div>
                    `;
                    showCreateButton();
                    return;
                }

                showEditDeleteButtons();
                renderBankOptions(data);

            } catch (error) {
                console.error('Error loading bank options:', error);
                document.getElementById('options-content').innerHTML = `
                    <div class="no-data">
                        <h3>Error loading bank configuration</h3>
                        <p>Please try again or contact support.</p>
                    </div>
                `;
            }
        }

        // Kubernetes section rendering helper
        function renderK8sSection(data) {
            if (!data.kubernetes_enabled) {
                return `
                    <div class="section-card">
                        <h3>Kubernetes Deployment</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Enabled</span>
                                <span class="option-value"><span class="badge-no">No</span></span>
                            </div>
                        </div>
                    </div>
                `;
            }

            const deployments = data.kubernetes_deployments || [];
            if (deployments.length === 0) {
                return `
                    <div class="section-card">
                        <h3>Kubernetes Deployment</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Enabled</span>
                                <span class="option-value"><span class="badge-yes">Yes</span></span>
                            </div>
                            <p class="text-muted">No deployments configured</p>
                        </div>
                    </div>
                `;
            }

            const SCHEMA_LABELS = {
                'txn': 'TXN',
                'meta': 'META',
                'recon': 'RECON',
                'report': 'REPORT',
                'mandate': 'MANDATE'
            };

            // Calculate total pods (min and max)
            const totalMinPods = deployments.reduce((sum, dep) => sum + (dep.min_replicas || 0), 0);
            const totalMaxPods = deployments.reduce((sum, dep) => sum + (dep.max_replicas || 0), 0);

            const deploymentsHtml = deployments.map((dep, idx) => {
                const dbPoolConfig = dep.db_pool_config || {};
                const hasDbPool = Object.keys(dbPoolConfig).length > 0;
                const minPods = dep.min_replicas || 1;
                const maxPods = dep.max_replicas || minPods;

                const dbPoolHtml = hasDbPool ? `
                    <div class="k8s-subsection">
                        <div class="k8s-subsection-title">DB Pool (${minPods}-${maxPods} pods)</div>
                        <div class="db-pool-display-grid">
                            ${['txn', 'meta', 'recon', 'report', 'mandate'].map(schema => {
                                const pool = dbPoolConfig[schema] || {};
                                const poolMin = pool.min !== null && pool.min !== undefined ? pool.min : 0;
                                const poolMax = pool.max !== null && pool.max !== undefined ? pool.max : 0;
                                // Min connections = pool_min * min_pods
                                // Max connections = pool_max * max_pods
                                const totalMin = poolMin * minPods;
                                const totalMax = poolMax * maxPods;
                                return `
                                    <div class="db-pool-display-item">
                                        <div class="schema-name">${SCHEMA_LABELS[schema]}</div>
                                        <div class="pool-values">${poolMin || '-'} / ${poolMax || '-'}</div>
                                        <div class="pool-total">= ${totalMin} - ${totalMax}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '';

                const albHtml = dep.alb_enabled ? `
                    <div class="k8s-subsection">
                        <div class="k8s-subsection-title">ALB</div>
                        <div class="alb-info">
                            <div class="alb-info-item">
                                <div class="label">Name</div>
                                <div class="value">${dep.alb_name || 'N/A'}</div>
                            </div>
                            <div class="alb-info-item">
                                <div class="label">Target Group</div>
                                <div class="value">${dep.alb_target_group || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                ` : '';

                return `
                    <div class="k8s-deployment-view-card">
                        <div class="k8s-deployment-view-header">
                            <h4>${dep.deployment_name || 'Unnamed'}</h4>
                            <span class="namespace-badge">${dep.namespace || 'default'}</span>
                        </div>
                        <div class="k8s-deployment-view-body">
                            <div class="k8s-info-grid">
                                <div class="k8s-info-item">
                                    <div class="value">${minPods} - ${maxPods}</div>
                                    <div class="label">Pods</div>
                                </div>
                                <div class="k8s-info-item">
                                    <div class="value">${dep.cpu_request || '-'}</div>
                                    <div class="label">CPU Req</div>
                                </div>
                                <div class="k8s-info-item">
                                    <div class="value">${dep.memory_request || '-'}</div>
                                    <div class="label">Mem Req</div>
                                </div>
                                <div class="k8s-info-item">
                                    <div class="value">${dep.alb_enabled ? '<span class="badge-yes">Y</span>' : '<span class="badge-no">N</span>'}</div>
                                    <div class="label">ALB</div>
                                </div>
                            </div>
                            ${albHtml}
                            ${dbPoolHtml}
                        </div>
                    </div>
                `;
            }).join('');

            // Calculate total connection pool per schema across all deployments
            // Min = pool_min * min_pods, Max = pool_max * max_pods
            const totalPools = {
                txn: { min: 0, max: 0 },
                meta: { min: 0, max: 0 },
                recon: { min: 0, max: 0 },
                report: { min: 0, max: 0 },
                mandate: { min: 0, max: 0 }
            };

            deployments.forEach(dep => {
                const dbPoolConfig = dep.db_pool_config || {};
                const minPods = dep.min_replicas || 1;
                const maxPods = dep.max_replicas || minPods;
                ['txn', 'meta', 'recon', 'report', 'mandate'].forEach(schema => {
                    const pool = dbPoolConfig[schema] || {};
                    if (pool.min) totalPools[schema].min += (pool.min * minPods);
                    if (pool.max) totalPools[schema].max += (pool.max * maxPods);
                });
            });

            // Calculate grand total
            const grandTotalMin = Object.values(totalPools).reduce((sum, p) => sum + p.min, 0);
            const grandTotalMax = Object.values(totalPools).reduce((sum, p) => sum + p.max, 0);

            const totalSummaryHtml = `
                <div class="k8s-total-summary">
                    <div class="k8s-total-summary-title">
                        Total DB Connections (${deployments.length} deployments | ${totalMinPods}-${totalMaxPods} pods)
                    </div>
                    <div class="k8s-total-grid">
                        ${['txn', 'meta', 'recon', 'report', 'mandate'].map(schema => `
                            <div class="k8s-total-item">
                                <div class="schema-name">${SCHEMA_LABELS[schema]}</div>
                                <div class="total-values">${totalPools[schema].min} - ${totalPools[schema].max}</div>
                                <div class="total-label">Min - Max</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: var(--spacing-3); padding-top: var(--spacing-3); border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
                        <div style="color: rgba(255,255,255,0.7); font-size: var(--font-size-xs); text-transform: uppercase;">Grand Total Connections</div>
                        <div style="color: white; font-size: var(--font-size-xl); font-weight: 700;">${grandTotalMin} - ${grandTotalMax}</div>
                        <div style="color: rgba(255,255,255,0.6); font-size: var(--font-size-xs);">Min Pods x Pool Min â€” Max Pods x Pool Max</div>
                    </div>
                </div>
            `;

            return `
                <div class="k8s-section-card">
                    <h3>
                        <span>Kubernetes Deployments</span>
                        <span class="deployment-count">${deployments.length} deployments | ${totalMinPods}-${totalMaxPods} pods</span>
                    </h3>
                    <div class="k8s-deployments-container">
                        <div class="k8s-deployments-grid">
                            ${deploymentsHtml}
                        </div>
                    </div>
                    ${totalSummaryHtml}
                </div>
            `;
        }

        function renderBankOptions(data) {
            const formatNumber = (num) => {
                if (num === null || num === undefined) return 'N/A';
                return num.toLocaleString();
            };

            const yesNo = (val) => val ? '<span class="badge-yes">Yes</span>' : '<span class="badge-no">No</span>';
            const displayValue = (val) => val || 'N/A';

            const content = `
                <div class="options-grid">
                    <!-- Transaction Volume Section -->
                    <div class="section-card">
                        <h3>Transaction Volume</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Daily Volume</span>
                                <span class="option-value volume-number">${formatNumber(data.transaction_volume_per_day)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Monthly Volume</span>
                                <span class="option-value volume-number">${formatNumber(data.transaction_volume_per_month)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Peak TPS</span>
                                <span class="option-value volume-number">${formatNumber(data.peak_tps)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- App Server Section -->
                    <div class="section-card">
                        <h3>Application Servers</h3>
                        <div class="section-card-body">
                            <div class="server-card">
                                <div class="server-card-header">
                                    <span class="server-count">${formatNumber(data.number_of_app_servers)}</span>
                                    <span class="server-type">${displayValue(data.app_server_type)}</span>
                                </div>
                                <div class="server-specs">
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.app_server_cpu)}</span>
                                        <span class="spec-label">CPU</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.app_server_memory)}</span>
                                        <span class="spec-label">Memory</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.app_server_os)}</span>
                                        <span class="spec-label">Operating System</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Section -->
                    <div class="section-card">
                        <h3>Database Servers</h3>
                        <div class="section-card-body">
                            <div class="server-card">
                                <div class="server-card-header">
                                    <span class="server-count">${formatNumber(data.number_of_db_instances)}</span>
                                    <span class="server-type">${displayValue(data.db_type)}</span>
                                </div>
                                <div class="server-specs">
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.db_server_cpu)}</span>
                                        <span class="spec-label">CPU</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.db_server_memory)}</span>
                                        <span class="spec-label">Memory</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.db_server_storage)}</span>
                                        <span class="spec-label">Storage</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.db_server_os)}</span>
                                        <span class="spec-label">Operating System</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aerospike Section -->
                    <div class="section-card">
                        <h3>Aerospike Cache</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Enabled</span>
                                <span class="option-value">${yesNo(data.aerospike_enabled)}</span>
                            </div>
                            ${data.aerospike_enabled ? `
                            <div class="option-row">
                                <span class="option-label">Version</span>
                                <span class="option-value"><span class="badge-tech">${displayValue(data.aerospike_version)}</span></span>
                            </div>
                            <div class="server-card">
                                <div class="server-card-header">
                                    <span class="server-count">${formatNumber(data.number_of_aerospike_servers)}</span>
                                    <span class="server-type">Servers</span>
                                </div>
                                <div class="server-specs">
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.aerospike_server_cpu)}</span>
                                        <span class="spec-label">CPU</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.aerospike_server_memory)}</span>
                                        <span class="spec-label">Memory</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.aerospike_server_storage)}</span>
                                        <span class="spec-label">Storage</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-value">${displayValue(data.aerospike_server_os)}</span>
                                        <span class="spec-label">OS</span>
                                    </div>
                                </div>
                            </div>
                            ${data.aerospike_description ? `<div class="description-text">${data.aerospike_description}</div>` : ''}
                            ` : ''}
                        </div>
                    </div>

                    <!-- Redis Section -->
                    <div class="section-card">
                        <h3>Redis Cache</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Enabled</span>
                                <span class="option-value">${yesNo(data.redis_enabled)}</span>
                            </div>
                            ${data.redis_enabled ? `
                            <div class="option-row">
                                <span class="option-label">Version</span>
                                <span class="option-value"><span class="badge-tech">${displayValue(data.redis_version)}</span></span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Number of Servers</span>
                                <span class="option-value">${formatNumber(data.number_of_redis_servers)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Memory per Server</span>
                                <span class="option-value">${displayValue(data.redis_server_memory)}</span>
                            </div>
                            ${data.redis_description ? `<div class="description-text">${data.redis_description}</div>` : ''}
                            ` : ''}
                        </div>
                    </div>

                    <!-- Load Balancer Section -->
                    <div class="section-card">
                        <h3>Load Balancer</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Type</span>
                                <span class="option-value">${displayValue(data.load_balancer_type)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Count</span>
                                <span class="option-value">${formatNumber(data.number_of_load_balancers)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Monitoring & Logging Section -->
                    <div class="section-card">
                        <h3>Monitoring & Logging</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Monitoring Tool</span>
                                <span class="option-value">${data.monitoring_tool ? `<span class="badge-tech">${data.monitoring_tool}</span>` : 'N/A'}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Logging Tool</span>
                                <span class="option-value">${data.logging_tool ? `<span class="badge-tech">${data.logging_tool}</span>` : 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Network & Security Section -->
                    <div class="section-card">
                        <h3>Network & Security</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Network Zone</span>
                                <span class="option-value">${displayValue(data.network_zone)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">WAF Enabled</span>
                                <span class="option-value">${yesNo(data.waf_enabled)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">SSL Certificate Expiry</span>
                                <span class="option-value">${data.ssl_certificate_expiry ? new Date(data.ssl_certificate_expiry).toLocaleDateString() : 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Environment Section -->
                    <div class="section-card">
                        <h3>Environment & DR</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Deployment Region</span>
                                <span class="option-value">${displayValue(data.deployment_region)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Data Center</span>
                                <span class="option-value">${displayValue(data.data_center)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">Disaster Recovery</span>
                                <span class="option-value">${yesNo(data.dr_enabled)}</span>
                            </div>
                            ${data.dr_enabled && data.dr_location ? `
                            <div class="option-row">
                                <span class="option-label">DR Location</span>
                                <span class="option-value">${data.dr_location}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- SLA Section -->
                    <div class="section-card">
                        <h3>SLA & Recovery</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Uptime SLA</span>
                                <span class="option-value volume-number">${displayValue(data.uptime_sla)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">RTO (Recovery Time)</span>
                                <span class="option-value">${displayValue(data.rto)}</span>
                            </div>
                            <div class="option-row">
                                <span class="option-label">RPO (Recovery Point)</span>
                                <span class="option-value">${displayValue(data.rpo)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Kubernetes Deployment Section -->
                    ${renderK8sSection(data)}

                    <!-- Reconciliation Section -->
                    <div class="section-card">
                        <h3>Reconciliation</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Enabled</span>
                                <span class="option-value">${yesNo(data.recon_enabled)}</span>
                            </div>
                            ${data.recon_enabled ? `
                            <div class="option-row">
                                <span class="option-label">Technology</span>
                                <span class="option-value">${data.recon_technology ? `<span class="badge-tech">${data.recon_technology}</span>` : 'N/A'}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Team Contacts Section -->
                    <div class="section-card">
                        <h3>Team Contacts</h3>
                        <div class="section-card-body">
                            <div class="option-row">
                                <span class="option-label">Implementation Developer</span>
                                <span class="option-value">${displayValue(data.implementation_developer_name)}</span>
                            </div>
                            ${data.implementation_developer_contact ? `
                            <div class="option-row">
                                <span class="option-label">Contact</span>
                                <span class="option-value">${data.implementation_developer_contact}</span>
                            </div>
                            ` : ''}
                            <div class="option-row">
                                <span class="option-label">DB Developer</span>
                                <span class="option-value">${displayValue(data.db_developer_name)}</span>
                            </div>
                            ${data.db_developer_contact ? `
                            <div class="option-row">
                                <span class="option-label">DB Contact</span>
                                <span class="option-value">${data.db_developer_contact}</span>
                            </div>
                            ` : ''}
                            ${data.ops_team_contact ? `
                            <div class="option-row">
                                <span class="option-label">Ops Team</span>
                                <span class="option-value">${data.ops_team_contact}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Architecture Diagram Section -->
                    <div class="section-card">
                        <h3>Architecture Diagram</h3>
                        <div class="section-card-body">
                            ${data.architecture_diagram_url ? `
                            <div class="architecture-diagram">
                                <a href="${data.architecture_diagram_url}" target="_blank">View Architecture Diagram</a>
                            </div>
                            ` : '<p class="text-muted">No architecture diagram available</p>'}
                        </div>
                    </div>
                </div>

                <div class="updated-info">
                    Last updated: ${data.updated_at ? new Date(data.updated_at).toLocaleString() : 'N/A'}
                    ${data.updated_by_name ? ` by <strong>${data.updated_by_name}</strong>` : ''}
                </div>
            `;

            document.getElementById('options-content').innerHTML = content;
        }

        function hideButtons() {
            const btnEdit = document.getElementById('btn-edit');
            const btnDelete = document.getElementById('btn-delete');
            const btnCreate = document.getElementById('btn-create');
            if (btnEdit) btnEdit.style.display = 'none';
            if (btnDelete) btnDelete.style.display = 'none';
            if (btnCreate) btnCreate.style.display = 'none';
        }

        function showCreateButton() {
            const btnEdit = document.getElementById('btn-edit');
            const btnDelete = document.getElementById('btn-delete');
            const btnCreate = document.getElementById('btn-create');
            if (btnEdit) btnEdit.style.display = 'none';
            if (btnDelete) btnDelete.style.display = 'none';
            if (btnCreate && isAdmin) btnCreate.style.display = 'inline-flex';
        }

        function showEditDeleteButtons() {
            const btnEdit = document.getElementById('btn-edit');
            const btnDelete = document.getElementById('btn-delete');
            const btnCreate = document.getElementById('btn-create');
            if (btnEdit && isAdmin) btnEdit.style.display = 'inline-flex';
            if (btnDelete && isAdmin) btnDelete.style.display = 'inline-flex';
            if (btnCreate) btnCreate.style.display = 'none';
        }

        function editBankOption() {
            if (currentBankId) {
                window.location.href = `/bank-options-edit/${currentBankId}`;
            }
        }

        function createBankOption() {
            if (currentBankId) {
                window.location.href = `/bank-options-edit/${currentBankId}?create=true`;
            }
        }

        async function deleteBankOption() {
            if (!currentBankId) return;

            if (!confirm('Are you sure you want to delete this bank configuration? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/bank-options/${currentBankId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Bank configuration deleted successfully');
                    loadBankOptions();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to delete bank configuration'));
                }
            } catch (error) {
                console.error('Error deleting bank option:', error);
                alert('Error deleting bank configuration');
            }
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        // Add New Bank Modal Functions
        function openAddBankModal() {
            document.getElementById('add-bank-modal').classList.add('active');
            document.getElementById('new-bank-name').value = '';
            document.getElementById('new-bank-name').focus();
        }

        function closeAddBankModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('add-bank-modal').classList.remove('active');
        }

        async function saveNewBank() {
            const bankName = document.getElementById('new-bank-name').value.trim();

            if (!bankName) {
                alert('Please enter a bank name');
                return;
            }

            try {
                const response = await fetch('/banks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: bankName })
                });

                if (response.ok) {
                    const newBank = await response.json();
                    closeAddBankModal();

                    // Refresh banks dropdown and select the new bank
                    const select = document.getElementById('bank-select');
                    const option = document.createElement('option');
                    option.value = newBank.id;
                    option.textContent = newBank.name;
                    select.appendChild(option);
                    select.value = newBank.id;

                    alert('Bank added successfully!');
                    loadBankOptions();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to add bank'));
                }
            } catch (error) {
                console.error('Error adding bank:', error);
                alert('Error adding bank');
            }
        }

        // Handle Enter key in modal
        document.getElementById('new-bank-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveNewBank();
            }
        });

        loadBanks();
    </script>
</body>
</html>
