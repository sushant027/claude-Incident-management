<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Bank Options - Incident Management</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .form-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-section h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #1f3a5f;
            color: #1f3a5f;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="url"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .conditional-fields {
            margin-top: 10px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 4px;
            display: none;
        }
        .conditional-fields.active {
            display: block;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .btn-save {
            background: #38a169;
        }
        .btn-save:hover {
            background: #2f855a;
        }
        .btn-cancel {
            background: #718096;
        }
        .btn-cancel:hover {
            background: #4a5568;
        }
        .hint {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        .bank-name-header {
            background: #1f3a5f;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .bank-name-header h2 {
            margin: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="navbar-brand">Incident Management</a>
        <ul class="navbar-menu">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/incidents-list">Incidents</a></li>
            <li><a href="/search">Search</a></li>
            <li><a href="/bank-options">Bank Options</a></li>
        </ul>
        <div class="navbar-user">
            <span>{{ user.name }} ({{ user.role }})</span>
            <button onclick="logout()" class="btn btn-small btn-secondary">Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="form-container">
            <div class="bank-name-header">
                <h2 id="page-title">Edit Bank Configuration</h2>
            </div>

            <form id="bank-option-form" onsubmit="saveForm(event)">
                <!-- Transaction Volume Section -->
                <div class="form-section">
                    <h3>Transaction Volume</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transaction_volume_per_day">Transactions Per Day</label>
                            <input type="number" id="transaction_volume_per_day" name="transaction_volume_per_day" min="0">
                            <div class="hint">Average daily transaction count</div>
                        </div>
                        <div class="form-group">
                            <label for="transaction_volume_per_month">Transactions Per Month</label>
                            <input type="number" id="transaction_volume_per_month" name="transaction_volume_per_month" min="0">
                            <div class="hint">Average monthly transaction count</div>
                        </div>
                    </div>
                </div>

                <!-- Architecture Section -->
                <div class="form-section">
                    <h3>Architecture</h3>
                    <div class="form-group">
                        <label for="architecture_diagram_url">Architecture Diagram URL</label>
                        <input type="url" id="architecture_diagram_url" name="architecture_diagram_url" placeholder="https://...">
                        <div class="hint">Link to architecture diagram (PNG, PDF, or documentation URL)</div>
                    </div>
                </div>

                <!-- App Server Section -->
                <div class="form-section">
                    <h3>Application Server</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="number_of_app_servers">Number of App Servers</label>
                            <input type="number" id="number_of_app_servers" name="number_of_app_servers" min="0">
                        </div>
                        <div class="form-group">
                            <label for="app_server_type">App Server Type</label>
                            <input type="text" id="app_server_type" name="app_server_type" placeholder="e.g., Tomcat, JBoss, WebLogic">
                        </div>
                    </div>
                </div>

                <!-- Database Section -->
                <div class="form-section">
                    <h3>Database</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="db_type">Database Type</label>
                            <input type="text" id="db_type" name="db_type" placeholder="e.g., Oracle, PostgreSQL, MySQL">
                        </div>
                        <div class="form-group">
                            <label for="number_of_db_instances">Number of DB Instances</label>
                            <input type="number" id="number_of_db_instances" name="number_of_db_instances" min="0">
                        </div>
                    </div>
                </div>

                <!-- Developer Contacts Section -->
                <div class="form-section">
                    <h3>Developer Contacts</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="implementation_developer_name">Implementation Developer Name</label>
                            <input type="text" id="implementation_developer_name" name="implementation_developer_name">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="db_developer_name">DB Developer Name</label>
                            <input type="text" id="db_developer_name" name="db_developer_name">
                        </div>
                        <div class="form-group">
                            <label for="db_developer_contact">DB Developer Contact</label>
                            <input type="text" id="db_developer_contact" name="db_developer_contact" placeholder="Email or phone number">
                        </div>
                    </div>
                </div>

                <!-- Aerospike Section -->
                <div class="form-section">
                    <h3>Aerospike</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="aerospike_enabled" name="aerospike_enabled" onchange="toggleConditional('aerospike')">
                        <label for="aerospike_enabled">Aerospike Enabled</label>
                    </div>
                    <div id="aerospike-fields" class="conditional-fields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="aerospike_version">Aerospike Version</label>
                                <input type="text" id="aerospike_version" name="aerospike_version" placeholder="e.g., 6.2.0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="aerospike_description">Aerospike Description</label>
                            <textarea id="aerospike_description" name="aerospike_description" placeholder="Describe the Aerospike setup and usage"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Redis Section -->
                <div class="form-section">
                    <h3>Redis</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="redis_enabled" name="redis_enabled" onchange="toggleConditional('redis')">
                        <label for="redis_enabled">Redis Enabled</label>
                    </div>
                    <div id="redis-fields" class="conditional-fields">
                        <div class="form-group">
                            <label for="redis_description">Redis Description</label>
                            <textarea id="redis_description" name="redis_description" placeholder="Describe the Redis setup and usage"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Recon Section -->
                <div class="form-section">
                    <h3>Reconciliation (Recon)</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="recon_enabled" name="recon_enabled" onchange="toggleConditional('recon')">
                        <label for="recon_enabled">Recon Enabled</label>
                    </div>
                    <div id="recon-fields" class="conditional-fields">
                        <div class="form-group">
                            <label for="recon_technology">Recon Technology</label>
                            <select id="recon_technology" name="recon_technology">
                                <option value="">-- Select Technology --</option>
                                <option value="redis">Redis</option>
                                <option value="pandas">Pandas</option>
                                <option value="procedure">Stored Procedure</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="cancel()">Cancel</button>
                    <button type="submit" class="btn btn-save">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const bankId = {{ bank_id }};
        let isCreateMode = false;
        let existingData = null;

        async function loadBankOption() {
            try {
                // Check if create mode
                const urlParams = new URLSearchParams(window.location.search);
                isCreateMode = urlParams.get('create') === 'true';

                const response = await fetch(`/bank-options/${bankId}`);
                const data = await response.json();

                if (data.bank_name) {
                    document.getElementById('page-title').textContent =
                        (isCreateMode || !data.exists ? 'Create' : 'Edit') +
                        ` Configuration - ${data.bank_name}`;
                }

                if (data.exists && !isCreateMode) {
                    existingData = data;
                    populateForm(data);
                }

            } catch (error) {
                console.error('Error loading bank option:', error);
            }
        }

        function populateForm(data) {
            // Transaction volume
            setValue('transaction_volume_per_day', data.transaction_volume_per_day);
            setValue('transaction_volume_per_month', data.transaction_volume_per_month);

            // Architecture
            setValue('architecture_diagram_url', data.architecture_diagram_url);

            // App server
            setValue('number_of_app_servers', data.number_of_app_servers);
            setValue('app_server_type', data.app_server_type);

            // Database
            setValue('db_type', data.db_type);
            setValue('number_of_db_instances', data.number_of_db_instances);

            // Developers
            setValue('implementation_developer_name', data.implementation_developer_name);
            setValue('db_developer_name', data.db_developer_name);
            setValue('db_developer_contact', data.db_developer_contact);

            // Aerospike
            setCheckbox('aerospike_enabled', data.aerospike_enabled);
            toggleConditional('aerospike');
            setValue('aerospike_version', data.aerospike_version);
            setValue('aerospike_description', data.aerospike_description);

            // Redis
            setCheckbox('redis_enabled', data.redis_enabled);
            toggleConditional('redis');
            setValue('redis_description', data.redis_description);

            // Recon
            setCheckbox('recon_enabled', data.recon_enabled);
            toggleConditional('recon');
            setValue('recon_technology', data.recon_technology);
        }

        function setValue(id, value) {
            const el = document.getElementById(id);
            if (el && value !== null && value !== undefined) {
                el.value = value;
            }
        }

        function setCheckbox(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.checked = !!value;
            }
        }

        function toggleConditional(section) {
            const checkbox = document.getElementById(`${section}_enabled`);
            const fields = document.getElementById(`${section}-fields`);
            if (checkbox && fields) {
                if (checkbox.checked) {
                    fields.classList.add('active');
                } else {
                    fields.classList.remove('active');
                }
            }
        }

        async function saveForm(event) {
            event.preventDefault();

            const formData = {
                bank_id: bankId,
                transaction_volume_per_day: getIntValue('transaction_volume_per_day'),
                transaction_volume_per_month: getIntValue('transaction_volume_per_month'),
                architecture_diagram_url: getStringValue('architecture_diagram_url'),
                number_of_app_servers: getIntValue('number_of_app_servers'),
                app_server_type: getStringValue('app_server_type'),
                db_type: getStringValue('db_type'),
                number_of_db_instances: getIntValue('number_of_db_instances'),
                implementation_developer_name: getStringValue('implementation_developer_name'),
                db_developer_name: getStringValue('db_developer_name'),
                db_developer_contact: getStringValue('db_developer_contact'),
                aerospike_enabled: document.getElementById('aerospike_enabled').checked,
                aerospike_version: getStringValue('aerospike_version'),
                aerospike_description: getStringValue('aerospike_description'),
                redis_enabled: document.getElementById('redis_enabled').checked,
                redis_description: getStringValue('redis_description'),
                recon_enabled: document.getElementById('recon_enabled').checked,
                recon_technology: getStringValue('recon_technology')
            };

            try {
                let response;
                const shouldCreate = isCreateMode || !existingData || !existingData.exists;

                if (shouldCreate) {
                    response = await fetch('/bank-options', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch(`/bank-options/${bankId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    alert('Configuration saved successfully!');
                    window.location.href = `/bank-options?bank_id=${bankId}`;
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to save configuration'));
                }
            } catch (error) {
                console.error('Error saving form:', error);
                alert('Error saving configuration');
            }
        }

        function getIntValue(id) {
            const el = document.getElementById(id);
            const val = el ? parseInt(el.value) : null;
            return isNaN(val) ? null : val;
        }

        function getStringValue(id) {
            const el = document.getElementById(id);
            return el && el.value ? el.value : null;
        }

        function cancel() {
            window.location.href = `/bank-options?bank_id=${bankId}`;
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        loadBankOption();
    </script>
</body>
</html>
